<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Merry Christmas</title>

<style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
        overflow: hidden;
        background: #120622;
        font-family: sans-serif;
        color: white;
        text-align: center;
    }
    #overlay{
        position: absolute;
        z-index: 10;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.6);
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        backdrop-filter: blur(8px);
    }
    .btn{
        padding: 12px 20px;
        margin: 10px;
        font-size: 18px;
        background: #ffb6f6;
        color: #4a004f;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: 0.2s;
    }
    .btn:hover{ transform: scale(1.05); background: #ffc8fa; }
    #titleText {
        font-size: 42px;
        font-weight: bold;
        margin-top: 30px;
        color: #ffb6f6;
        text-shadow: 0 0 16px #ff80f7;
    }
    #subText {
        font-size: 24px;
        margin-top: 8px;
        color: #ffeaff;
        text-shadow: 0 0 10px #ff99ff;
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/three@0.115/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.115/examples/js/postprocessing/EffectComposer.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.115/examples/js/postprocessing/RenderPass.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.115/examples/js/postprocessing/UnrealBloomPass.js"></script>

</head>
<body>

<div id="overlay">
    <h2 style="margin-bottom:20px;font-size:28px;">请选择背景音乐</h2>

    <button class="btn" onclick="loadAudio(0)">张杰 – 明天过后</button>
    <button class="btn" onclick="loadAudio(1)">吴亦凡 & 赵丽颖 – 想你</button>
</div>

<div id="titleText">琰琰 圣诞快乐</div>
<div id="subText">Merry Christmas ✨</div>

<script>
let scene, camera, renderer, composer;
let sparks = [];
const total = 3000;   // 全局雪量

// ✨ 大树亮起（7秒后触发）
function highlightTree(){
    sparks.forEach(p => {
        if(p.isMain){
            p.material.color.set(0xff77ff);   // 粉色更亮
            p.material.size = 18;
        } else {
            p.material.color.set(0x222222);   // 周围暗下
            p.material.size = 4;
        }
    });
}

function loadAudio(index){
    document.getElementById("overlay").innerHTML = "<h2 style='font-size:26px;'>加载中，请稍候…</h2>";

    const audioFiles = [
        "mingtianguohou.mp3",
        "xiangni.mp3"
    ];

    const listener = new THREE.AudioListener();
    camera.add(listener);

    const bgm = new THREE.Audio(listener);
    const audioLoader = new THREE.AudioLoader();

    audioLoader.load(audioFiles[index], function(buffer){
        bgm.setBuffer(buffer);
        bgm.setLoop(true);
        bgm.setVolume(0.8);
        bgm.play();

        document.getElementById("overlay").remove();

        initScene();

        // ✨ 大树亮起延迟：7000ms（7秒）
        setTimeout(highlightTree, 7000);
    });
}

function initScene(){
    scene = new THREE.Scene();
    renderer = new THREE.WebGLRenderer({ antialias:true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    camera = new THREE.PerspectiveCamera(
        60,
        window.innerWidth / window.innerHeight,
        1,
        2000
    );
    camera.position.set(0, 0, 450);

    // Bloom(发光)
    composer = new THREE.EffectComposer(renderer);
    const renderPass = new THREE.RenderPass(scene, camera);
    const bloomPass = new THREE.UnrealBloomPass(
        new THREE.Vector2(window.innerWidth, window.innerHeight),
        1.2, 0.4, 0.6
    );
    composer.addPass(renderPass);
    composer.addPass(bloomPass);

    createTree();
    createSnow();
    animate();
}

function createTree(){
    const geometry = new THREE.BufferGeometry();
    const positions = [];

    for(let i=0;i<total;i++){
        const layer = Math.random() * 22;      // 树分层
        const radius = 160 - layer * 6;        // 每层半径缩小
        const angle = Math.random() * Math.PI * 2;

        const x = Math.cos(angle) * radius;
        const y = layer * 12 - 140;
        const z = Math.sin(angle) * radius;

        positions.push(x,y,z);
    }

    geometry.setAttribute("position", new THREE.Float32BufferAttribute(positions,3));

    const material = new THREE.PointsMaterial({
        color: 0xffccff,
        size: 6,
        transparent: true,
        opacity: 0.9
    });

    const points = new THREE.Points(geometry, material);

    // 标记为树主结构（7秒后粉亮）
    points.isMain = true;
    sparks.push(points);

    scene.add(points);
}

function createSnow(){
    const geometry = new THREE.BufferGeometry();
    const positions = [];

    for(let i=0;i<2500;i++){
        const x = (Math.random()-0.5)*1000;
        const y = Math.random()*600 - 300;
        const z = (Math.random()-0.5)*1000;
        positions.push(x,y,z);
    }

    geometry.setAttribute("position", new THREE.Float32BufferAttribute(positions,3));

    const material = new THREE.PointsMaterial({
        color: 0xffffff,
        size: 4,
        opacity: 0.8
    });

    const snow = new THREE.Points(geometry, material);
    snow.isMain = false;
    sparks.push(snow);

    scene.add(snow);
}

function animate(){
    requestAnimationFrame(animate);

    // 下雪飘动
    sparks.forEach(p=>{
        p.rotation.y += 0.0005;
    });

    composer.render();
}

</script>
</body>
</html>
